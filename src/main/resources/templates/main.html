<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Fit-News</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f7;
    }

    .title {
        text-align: center;
        font-size: 2.2em;
        margin: 24px 0 8px;
        font-weight: 800;
        letter-spacing: 0.04em;
        color: #111827;
    }

    header {
        background-color: #f2f2f2;
        padding: 10px 20px;
    }

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ ì¢Œìš° ì—¬ë°± ì¡°ê¸ˆ ë„“ê²Œ */
    .page-wrapper {
        max-width: 1200px;
        margin: 0 auto 40px;
        padding: 0 24px;
    }

    /* ì¶”ì²œ ì„¹í„°ì™€ ì¼ë°˜ ì„¹í„° êµ¬ë¶„ì„ ìœ„í•´ grid ë‘ ì¤„ë¡œ ë‚˜ëˆ” */
    .grid-container {
        display: grid;
        grid-template-columns: 1.1fr 1.1fr;
        grid-template-rows: auto auto; /* ìœ„ì¤„(ì¶”ì²œ), ì•„ë˜ì¤„(ì–¸ë¡ ì‚¬) */
        gap: 16px;
    }

    .grid-item {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px 14px 16px;
        background-color: #ffffff;
        overflow: hidden;
    }

    /* === ì„¹í„° 1,2 : ì¶”ì²œ ì˜ì—­ ê°•ì¡° === */
    .highlight-sector {
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
        position: relative;
        background: linear-gradient(135deg, #e0f2fe 0%, #f9fafb 45%, #fee2e2 100%);
    }

    .highlight-sector::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 14px;
        padding: 1px;
        background: linear-gradient(90deg, #38bdf8, #fb7185);
        -webkit-mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
    }

    /* ë¡œê·¸ì¸ ì•ˆ ë˜ì—ˆì„ ë•Œ ì¶•ì†Œ ìƒíƒœ */
    .collapsed-sector {
        min-height: 120px;
        box-shadow: none;
        background: #f9fafb;
    }

    .collapsed-sector .card-column {
        display: none;
    }

    /* ì„¹í„° í—¤ë”(ì œëª©) ìŠ¤íƒ€ì¼ */
    .sector-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 10px;
    }

    .sector-title {
        font-size: 18px;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
    }

    .sector-title span.icon {
        display: inline-flex;
        width: 22px;
        height: 22px;
        border-radius: 999px;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        color: #0f172a;
        background: white;
        box-shadow: 0 2px 6px rgba(15,23,42,0.18);
    }

    .sector-subtitle {
        font-size: 11px;
        color: #4b5563;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background-color: rgba(255,255,255,0.8);
    }

    .aligned-header .sector-title {
        color: #0f766e;
    }

    .opposite-header .sector-title {
        color: #b91c1c;
    }

    /* ì¶”ì²œ ì¹´ë“œ ì»¨í…Œì´ë„ˆ */
    .card-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* ë‰´ìŠ¤ ì¹´ë“œ ê³µí†µ */
    .news-card {
        display: flex;
        align-items: flex-start;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px;
        margin: 0 0 4px;
        text-decoration: none;
        color: inherit;
        background-color: #ffffff;
        overflow: hidden;
        transition: transform 0.08s ease, box-shadow 0.08s ease, background-color 0.08s ease;
    }
    .news-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(15, 23, 42, 0.12);
        background-color: #f9fafb;
    }

    /* ì¶”ì²œìš© ì¹´ë“œì˜ ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ ì•½ê°„ ê³ ì •(ì œëª©+2ì¤„ ì„¤ëª… ì •ë„) */
    .recommend-card {
        min-height: 110px;
        max-height: 110px;
    }

    .news-thumbnail {
        width: 92px;
        height: 72px;
        object-fit: cover;
        margin-right: 10px;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .news-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
    }

    .news-title {
        font-size: 14px;
        font-weight: 700;
        margin: 0 0 4px;
        color: #111827;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .news-desc {
        font-size: 12px;
        color: #4b5563;
        margin: 0 0 4px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .news-date {
        font-size: 11px;
        color: #9ca3af;
        margin-top: auto;
    }

    /* ë°˜ëŒ€ ì‹œê° íƒœê·¸ */
    .opposite-tag {
        font-size: 11px;
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        background-color: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
        margin-top: 4px;
    }

    /* ë¡œê·¸ì¸ ì•ˆë‚´ ë©”ì‹œì§€ */
    .recommend-message {
        margin-top: 10px;
        font-size: 13px;
        color: #4b5563;
    }
    .recommend-message a {
        color: #2563eb;
        text-decoration: underline;
        font-weight: 600;
    }

    /* ì–¸ë¡ ì‚¬ ì„¹í„°ëŠ” ì¡°ê¸ˆ ëœ ê°•ì¡° */
    .grid-item.news-by-source {
        background-color: #f9fafb;
        box-shadow: 0 2px 6px rgba(148, 163, 184, 0.2);
    }

    .grid-item.news-by-source h2 {
        font-size: 16px;
        margin-top: 0;
        margin-bottom: 8px;
        color: #111827;
    }

    /* ì„¹í„° 3~6 ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    .news-by-source-inner {
        max-height: 260px;
        overflow-y: auto;
        padding-right: 4px;
    }

    /* ìˆœì°¨ í˜ì´ë“œì¸ íš¨ê³¼ */
    .fade-in {
        opacity: 0;
        animation: fadeInUp 0.35s ease forwards;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(6px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
  </style>

  <script src="/js/auth.js"></script>
  <script>
    async function logClick(event, newsId) {
        const token = localStorage.getItem("accessToken");
        if (!token) return true;

        event.preventDefault();
        try {
            const res = await fetchWithAuth("/api/logs/click", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newsId })
            });

            if (res.ok) {
                const link = await res.text();
                window.location.href = link;
            } else {
                window.location.href = event.target.href;
            }
        } catch (e) {
            window.location.href = event.target.href;
        }

        return false;
    }
  </script>
</head>
<body>

<div class="title">Fit-News</div>
<header th:replace="fragments/header :: header"></header>

<div class="page-wrapper">

  <div class="grid-container">

    <!-- ì„¹í„° 1: ë‚´ ì„±í–¥ ë‰´ìŠ¤ -->
    <div class="grid-item highlight-sector" id="sector1">
      <div class="sector-header aligned-header">
        <h2 class="sector-title">
          <span class="icon">âœ“</span>
          ë‚´ ì„±í–¥ì— ë§ëŠ” ë‰´ìŠ¤
        </h2>
        <span class="sector-subtitle">ë‚˜ì™€ ì˜ ë§ëŠ” ê¸°ì‚¬ ì¶”ì²œ</span>
      </div>
      <div id="aligned-container" class="card-column"></div>
      <p id="recommend-message" class="recommend-message" style="display:none;"></p>
    </div>

    <!-- ì„¹í„° 2: ë°˜ëŒ€ ì„±í–¥ ë‰´ìŠ¤ -->
    <div class="grid-item highlight-sector" id="sector2">
      <div class="sector-header opposite-header">
        <h2 class="sector-title">
          <span class="icon">âš–</span>
          ë‹¤ë¥¸ ì‹œê°ì˜ ë‰´ìŠ¤
        </h2>
        <span class="sector-subtitle">ê· í˜• ì¡íŒ ì‹œê° ì œê³µ</span>
      </div>
      <div id="opposite-container" class="card-column"></div>
    </div>

    <!-- ì„¹í„° 3~6: ì–¸ë¡ ì‚¬ë³„ ë‰´ìŠ¤ -->
    <div th:each="entry, iterStat : ${newsList}" class="grid-item news-by-source"
         th:if="${iterStat.index >= 0 and iterStat.index < 4}">
      <h2 th:text="${entry.key}">ì–¸ë¡ ì‚¬</h2>
      <div class="news-by-source-inner">
        <div th:each="n : ${entry.value}">
          <a th:href="${n.link}" th:onclick="'return logClick(event,' + ${n.id} + ');'" class="news-card">
            <img th:src="${n.thumbnailUrl != null ? n.thumbnailUrl : '/images/default-thumb.png'}"
                 class="news-thumbnail" alt="ì¸ë„¤ì¼">
            <div class="news-content">
              <p class="news-title" th:text="${n.title}"></p>
              <p class="news-desc" th:text="${n.description}"></p>
              <p class="news-date" th:text="${#temporals.format(n.pubDate, 'yyyy-MM-dd HH:mm')}"></p>
            </div>
          </a>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
  // ì¶”ì²œ ë‰´ìŠ¤ í´ë¦­ ë¡œê·¸ + ì´ë™
  async function logAndGo(newsId, url) {
      try {
          const res = await fetchWithAuth("/api/logs/click", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify({ newsId })
          });

          const link = await res.text();
          window.open(link, "_blank");
      } catch (e) {
          console.error("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", e);
          window.open(url, "_blank");
      }
  }

  (async function () {
      const alignedContainer = document.getElementById("aligned-container");
      const oppositeContainer = document.getElementById("opposite-container");
      const sector1 = document.getElementById("sector1");
      const sector2 = document.getElementById("sector2");
      const msg = document.getElementById("recommend-message");

      try {
          const res = await fetchWithAuth("/api/recommend");

          // ğŸ” ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆì„ ë•Œ
          if (res.status === 401) {
              alignedContainer.innerHTML = "";
              oppositeContainer.innerHTML = "";

              sector1.classList.add("collapsed-sector");
              sector2.classList.add("collapsed-sector");

              msg.style.display = "block";
              msg.innerHTML = 'ë¡œê·¸ì¸ í•˜ì‹œê³  <a href="/login">ì¶”ì²œ ë‰´ìŠ¤ë¥¼ ë°›ì•„ë³´ì„¸ìš”</a>.';

              return;
          }

          if (!res.ok) {
              console.error("ì¶”ì²œ ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", res.status);
              return;
          }

          const data = await res.json();
          const aligned = data.aligned ?? data;
          const opposite = data.opposite ?? [];

          alignedContainer.innerHTML = "";
          oppositeContainer.innerHTML = "";
          msg.style.display = "none";
          sector1.classList.remove("collapsed-sector");
          sector2.classList.remove("collapsed-sector");

          // ê³µí†µ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
          function createCard(item, isOpposite, index) {
              const a = document.createElement("a");
              a.className = "news-card recommend-card fade-in";
              a.style.cursor = "pointer";
              a.style.animationDelay = (index * 0.08) + "s";

              a.onclick = (e) => {
                  e.preventDefault();
                  logAndGo(item.id, item.link);
              };

              const img = document.createElement("img");
              img.className = "news-thumbnail";
              img.src = item.thumbnailUrl || "/images/default-thumb.png";
              img.alt = "ì¸ë„¤ì¼";

              const content = document.createElement("div");
              content.className = "news-content";

              const title = document.createElement("p");
              title.className = "news-title";
              title.innerText = item.title || "(ì œëª© ì—†ìŒ)";

              const desc = document.createElement("p");
              desc.className = "news-desc";
              desc.innerText = item.description || "";

              const meta = document.createElement("p");
              meta.className = "news-date";
              meta.innerText = item.pubDate || "";

              content.appendChild(title);
              content.appendChild(desc);
              content.appendChild(meta);

              if (isOpposite) {
                  const tag = document.createElement("span");
                  tag.className = "opposite-tag";
                  tag.innerText = "ë‹¤ë¥¸ ì‹œê°ì˜ ê¸°ì‚¬";
                  content.appendChild(tag);
              }

              a.appendChild(img);
              a.appendChild(content);
              return a;
          }

          aligned.forEach((item, idx) => {
              alignedContainer.appendChild(createCard(item, false, idx));
          });

          opposite.forEach((item, idx) => {
              oppositeContainer.appendChild(createCard(item, true, idx));
          });

      } catch (e) {
          console.error("ì¶”ì²œ ë‰´ìŠ¤ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜:", e);
      }
  })();
</script>

</body>
</html>
