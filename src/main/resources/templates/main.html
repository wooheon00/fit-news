<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Fit-News</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f7f7f7;
    }

    .title {
        text-align: center;
        font-size: 2em;
        margin: 20px 0 10px;
    }

    header {
        background-color: #f2f2f2;
        padding: 10px 20px;
    }

    /* 2x3 ê·¸ë¦¬ë“œ - ì„¹í„° ë†’ì´ 1.5ë°°, ì–‘ì˜† ê³µë°± ì¤„ì´ê¸° */
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: repeat(3, 450px); /* 300px â†’ 450px */
        gap: 16px;
        padding: 20px 0 40px;
        max-width: 1400px;          /* ê³µë°± ì¤„ì´ê¸° (ê¸°ì¡´ 1200ë³´ë‹¤ ë„“ê²Œ) */
        margin: 0 auto;             /* ê°€ìš´ë° ì •ë ¬ */
    }

    .grid-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background-color: #fafafa;
        display: flex;              /* ì œëª© ê³ ì • + ë‚´ìš© ì˜ì—­ ë¶„ë¦¬ */
        flex-direction: column;
    }

    /* ì„¹í„° ì œëª© ê³ ì •, ì•„ë˜ ë‚´ìš©ë§Œ ë”°ë¡œ */
    .grid-item h2 {
        font-size: 16px;
        margin: 0 0 6px 0;
        flex: 0 0 auto;
    }

    /* ê³µí†µ ë‚´ìš© ì˜ì—­ (ê¸°ë³¸: ìŠ¤í¬ë¡¤ X) */
    .grid-content {
        flex: 1 1 auto;
        padding-right: 4px;
    }

    /* ì„¹í„° 3~6ì€ ìŠ¤í¬ë¡¤ í—ˆìš© */
    .grid-content-scroll {
        overflow-y: auto;
    }

    /* ì„¹í„° í…Œë§ˆ ìƒ‰ìƒ */
    .aligned-theme {
        border-color: #cfe8ff;
        background: #f4f8ff;
    }

    .aligned-theme h2 {
        color: #2563eb;
    }

    .aligned-theme .news-card {
        border-color: #d0e2ff;
        background: #ffffff;
    }

    .opposite-theme {
        border-color: #fecaca;
        background: #fff7f7;
    }

    .opposite-theme h2 {
        color: #b91c1c;
    }

    .opposite-theme .news-card {
        border-color: #fed7d7;
        background: #ffffff;
    }

    /* ë‰´ìŠ¤ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .news-card {
        display: flex;
        align-items: flex-start;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        text-decoration: none;
        color: inherit;
        background-color: #ffffff;
    }
    .news-card:hover {
        background-color: #f3f3f3;
    }

    /* ì¸ë„¤ì¼ í‚¤ìš°ê¸° */
    .news-thumbnail {
        width: 130px;   /* 80 â†’ 130 */
        height: 90px;   /* 60 â†’ 90 */
        object-fit: cover;
        margin-right: 12px;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .news-content {
        flex: 1;
    }

    /* ì œëª© ê°•ì¡° */
    .news-title {
        font-size: 16px;
        font-weight: 700;
        margin: 0 0 4px 0;
        line-height: 1.3;
    }

    .news-desc {
        font-size: 12px;
        color: #555;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .news-date {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
    }

    /* ì¶”ì²œ ë¯¸ë¡œê·¸ì¸ ë©”ì‹œì§€ */
    .login-message {
        font-size: 14px;
        color: #555;
        text-align: center;
        margin-top: 20px;
    }

    /* fade-in ì• ë‹ˆë©”ì´ì…˜ */
    .fade-in {
        opacity: 0;
        transform: translateY(8px);
        animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* footer */
    footer {
        background-color: #f2f2f2;
        padding: 16px 20px;
        font-size: 12px;
        color: #555;
        text-align: center;
        border-top: 1px solid #ddd;
        margin-top: 20px;
    }

    footer a {
        color: #2563eb;
        text-decoration: none;
    }

    footer a:hover {
        text-decoration: underline;
    }
  </style>

  <script src="/js/auth.js"></script>
  <script>
    async function logClick(event, newsId) {
        const token = localStorage.getItem("accessToken");
        if (!token) return true;

        event.preventDefault();
        try {
            const res = await fetchWithAuth("/api/logs/click", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newsId })
            });

            if (res.ok) {
                const link = await res.text();
                window.location.href = link;
            } else {
                window.location.href = event.target.href;
            }
        } catch (e) {
            window.location.href = event.target.href;
        }

        return false;
    }
  </script>
</head>
<body>

<div class="title">Fit-News</div>

<header th:replace="fragments/header :: header"></header>

<div class="grid-container">
  <!-- ì„¹í„° 1: ë‚´ ì„±í–¥ ë‰´ìŠ¤ (í•˜ëŠ˜ìƒ‰ ê³„ì—´) -->
  <div class="grid-item aligned-theme" id="sector1">
    <h2>ë‚´ ì„±í–¥ì— ë§ëŠ” ë‰´ìŠ¤</h2>
    <div class="grid-content">
      <div id="aligned-container"></div>
    </div>
  </div>

  <!-- ì„¹í„° 2: ë°˜ëŒ€ ì„±í–¥ ë‰´ìŠ¤ (íŒŒìŠ¤í…” ë ˆë“œ ê³„ì—´) -->
  <div class="grid-item opposite-theme" id="sector2">
    <h2>ë‹¤ë¥¸ ì‹œê°ì˜ ë‰´ìŠ¤</h2>
    <div class="grid-content">
      <div id="opposite-container"></div>
    </div>
  </div>

  <!-- ì„¹í„° 3~6: ê¸°ì¡´ ì–¸ë¡ ì‚¬ë³„ ë‰´ìŠ¤ (ìŠ¤í¬ë¡¤ í—ˆìš©) -->
  <div th:each="entry, iterStat : ${newsList}" class="grid-item"
       th:if="${iterStat.index >= 0 and iterStat.index < 4}">
    <h2 th:text="${entry.key}">ì–¸ë¡ ì‚¬</h2>
    <div class="grid-content grid-content-scroll">
      <div th:each="n : ${entry.value}">
        <a th:href="${n.link}" th:onclick="'return logClick(event,' + ${n.id} + ');'" class="news-card">
          <img th:src="${n.thumbnailUrl != null ? n.thumbnailUrl : '/images/default-thumb.png'}"
               class="news-thumbnail" alt="ì¸ë„¤ì¼">
          <div class="news-content">
            <p class="news-title" th:text="${n.title}"></p>
            <p class="news-desc" th:text="${n.description}"></p>
            <p class="news-date" th:text="${#temporals.format(n.pubDate, 'yyyy-MM-dd HH:mm')}"></p>
          </div>
        </a>
      </div>
    </div>
  </div>
</div>

<footer>
  ê±´êµ­ëŒ€í•™êµ ì¡¸ì—…í”„ë¡œì íŠ¸ Fit-News &nbsp; | &nbsp;
  íŒ€ì› - ì‹¬í˜„ë³´, ìµœìš°í—Œ &nbsp; | &nbsp;
  GitHub - <a href="https://github.com/wooheon00/fit-news" target="_blank" rel="noopener noreferrer">
  https://github.com/wooheon00/fit-news
</a>
</footer>

<script>
  // ì¶”ì²œ ë‰´ìŠ¤ í´ë¦­ ë¡œê·¸ + ì´ë™
  async function logAndGo(newsId, url) {
      try {
          const res = await fetchWithAuth("/api/logs/click", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify({ newsId })
          });

          const link = await res.text();
          window.open(link, "_blank");
      } catch (e) {
          console.error("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", e);
          window.open(url, "_blank");
      }
  }

  (async function () {
      try {
          const res = await fetchWithAuth("/api/recommend");

          const alignedContainer = document.getElementById("aligned-container");
          const oppositeContainer = document.getElementById("opposite-container");

          // ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš°
          if (res.status === 401) {
              alignedContainer.innerHTML =
                  '<p class="login-message">ë¡œê·¸ì¸ í›„ ë‰´ìŠ¤ ì¶”ì²œì„ ë°›ì•„ë³´ì„¸ìš”.</p>';
              oppositeContainer.innerHTML = "";
              console.log("ë¡œê·¸ì¸ í•„ìš”");
              return;
          }

          if (!res.ok) {
              console.error("ì¶”ì²œ ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", res.status);
              return;
          }

          const data = await res.json();

          const aligned = data.aligned ?? data;
          const opposite = data.opposite ?? [];

          alignedContainer.innerHTML = "";
          oppositeContainer.innerHTML = "";

          // ì¹´ë“œ ìƒì„± + fade-in + ì‹œê°„ì°¨ ë“±ì¥
          function createCard(item, isOpposite) {
              const a = document.createElement("a");
              a.className = "news-card fade-in"; // ğŸ”¥ fade-in í´ë˜ìŠ¤ ì¶”ê°€
              a.style.cursor = "pointer";
              a.onclick = (e) => {
                  e.preventDefault();
                  logAndGo(item.id, item.link);
              };

              const img = document.createElement("img");
              img.className = "news-thumbnail";
              img.src = item.thumbnailUrl || "/images/default-thumb.png";
              img.alt = "ì¸ë„¤ì¼";

              const content = document.createElement("div");
              content.className = "news-content";

              const title = document.createElement("p");
              title.className = "news-title";
              title.innerText = item.title || "(ì œëª© ì—†ìŒ)";

              const desc = document.createElement("p");
              desc.className = "news-desc";
              desc.innerText = item.description || "";

              const meta = document.createElement("p");
              meta.className = "news-date";
              meta.innerText = item.pubDate || "";

              content.appendChild(title);
              content.appendChild(desc);
              content.appendChild(meta);

              if (isOpposite) {
                  const tag = document.createElement("span");
                  tag.style.fontSize = "11px";
                  tag.style.display = "inline-block";
                  tag.style.marginTop = "4px";
                  tag.style.padding = "2px 6px";
                  tag.style.borderRadius = "999px";
                  tag.style.backgroundColor = "#fef2f2";
                  tag.style.color = "#b91c1c";
                  tag.innerText = "ë‹¤ë¥¸ ì‹œê°ì˜ ê¸°ì‚¬";
                  content.appendChild(tag);
              }

              a.appendChild(img);
              a.appendChild(content);

              return a;
          }

          // ì‹œê°„ì°¨ + fade-in ë“±ì¥ (aligned)
          aligned.forEach((item, index) => {
              const card = createCard(item, false);
              setTimeout(() => {
                  alignedContainer.appendChild(card);
              }, index * 150); // 0.15ì´ˆ ê°„ê²©
          });

          // ì‹œê°„ì°¨ + fade-in ë“±ì¥ (opposite)
          opposite.forEach((item, index) => {
              const card = createCard(item, true);
              setTimeout(() => {
                  oppositeContainer.appendChild(card);
              }, index * 150);
          });

      } catch (e) {
          console.error("ì¶”ì²œ ë‰´ìŠ¤ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜:", e);
      }
  })();
</script>

</body>
</html>
