<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ë‰´ìŠ¤ í…ŒìŠ¤íŠ¸</title>
    <meta charset="UTF-8">
    <style>
        .news-card {
            display: flex;
            align-items: flex-start;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            text-decoration: none;
            color: inherit;
        }
        .news-card:hover {
            background-color: #f9f9f9;
        }
        .news-thumbnail {
            width: 120px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 6px;
        }
        .news-content {
            flex: 1;
        }
        .news-title {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 5px 0;
        }
        .news-desc {
            font-size: 13px;
            color: #555;
            margin: 0;
        }
        .news-date {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>

    <!-- âœ… ë¡œê·¸ì¸/í† í° ê´€ë¦¬ í•¨ìˆ˜ í¬í•¨ -->
    <script src="/js/auth.js"></script>

    <script>
        async function logClick(event, newsId) {
            const token = localStorage.getItem("accessToken");

            // ë¡œê·¸ì¸ ì•ˆ í•œ ê²½ìš° â†’ ê·¸ëƒ¥ ë§í¬ë¡œ ì´ë™
            if (!token) {
                return true; // a íƒœê·¸ ê¸°ë³¸ ì´ë™ í—ˆìš©
            }

            // ë¡œê·¸ì¸ í•œ ê²½ìš° â†’ ë¡œê·¸ API í˜¸ì¶œ í›„ ì´ë™
            event.preventDefault(); // ê¸°ë³¸ ì´ë™ ë§‰ìŒ

            try {
                // âœ… fetchWithAuth ì‚¬ìš© (auth.jsì— ì •ì˜ë˜ì–´ ìˆìŒ)
                const res = await fetchWithAuth("/api/logs/click", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ newsId })
                });

                if (res.ok) {
                    const link = await res.text();
                    window.location.href = link; // ì›ë³¸ ê¸°ì‚¬ ì´ë™
                } else {
                    console.error("ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨", res.status);
                    // ì‹¤íŒ¨ ì‹œì—ëŠ” ê·¸ëƒ¥ ì›ë˜ hrefë¡œ ì´ë™
                    window.location.href = event.target.href;
                }
            } catch (e) {
                console.error("API í˜¸ì¶œ ì˜¤ë¥˜", e);
                window.location.href = event.target.href;
            }

            return false;
        }
    </script>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<h1>ë‰´ìŠ¤ í…ŒìŠ¤íŠ¸</h1>
<hr>

<!-- ğŸ”¥ newsBySource: Map<String, List<News>> -->
<div th:each="entry : ${newsList}">

    <!-- ë‰´ìŠ¤ì‚¬ ì œëª© -->
    <h2 class="source-title" th:text="${entry.key}"></h2>

    <!-- í•´ë‹¹ ë‰´ìŠ¤ì‚¬ê°€ ê°€ì§„ ë‰´ìŠ¤ ì¹´ë“œë“¤ -->
    <div th:each="n : ${entry.value}">
        <a th:href="${n.link}"
           th:onclick="'return logClick(event,' + ${n.id} + ');'"
           class="news-card">

            <!-- ì¸ë„¤ì¼ -->
            <img th:src="${n.thumbnailUrl != null ? n.thumbnailUrl : '/images/default-thumb.png'}"
                 alt="ì¸ë„¤ì¼" class="news-thumbnail">

            <!-- ì½˜í…ì¸  -->
            <div class="news-content">
                <p class="news-title" th:text="${n.title}"></p>
                <p class="news-desc" th:text="${n.description}"></p>
                <p class="news-date"
                   th:text="${#temporals.format(n.pubDate, 'yyyy-MM-dd HH:mm')}"></p>
            </div>
        </a>
    </div>

    <hr/>
</div>

</body>
</html>